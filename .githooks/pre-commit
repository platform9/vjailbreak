#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

cd "${REPO_ROOT}"

echo "[pre-commit] running golangci-lint (k8s/migration)"
make -C k8s/migration lint

echo "[pre-commit] running make build-installer"
before_status="$(git status --porcelain)"
make build-installer

after_status="$(git status --porcelain)"

if [[ "${before_status}" != "${after_status}" ]]; then
  echo "[pre-commit] ERROR: 'make build-installer' modified your working tree." >&2
  echo "[pre-commit] Please commit the generated changes (or revert them) and retry." >&2
  echo "[pre-commit] Current git status:" >&2
  git status --porcelain >&2
  exit 1
fi
