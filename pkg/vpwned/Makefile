SHELL := /usr/bin/env bash
BIN_DIR := $(shell pwd)/bin
BIN := vpwctl
RELEASE_VER=$(BUILD_VERSION)
GIT_SHA    := $(shell git rev-parse --short HEAD)
GIT_BRANCH := $(shell git rev-parse --abbrev-ref HEAD)
GIT_PARENT := $(shell git show-branch -a 2>/dev/null | grep '\*' | grep -v "$(GIT_BRANCH)" | head -n1 | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//')
GIT_TAG := $(shell git describe --exact-match --tags $(git log -n1 --pretty='%h'))
SWAGGER_UI_VER := 5.17.14
BUF_VERSION := 1.42.0

ifeq ($(BUILD_VERSION),)
	RELEASE_VER=$(GIT_PARENT)
ifneq ($(GIT_TAG),)
	RELEASE_VER=$(GIT_TAG)
ifeq ($(GIT_PARENT),)
	RELEASE_VER=99.99.99
endif
endif
endif

VERSION = $(RELEASE_VER)-$(GIT_BRANCH)-$(GIT_SHA)
LDFLAGS += "-s -w -X github.com/platform9/vjailbreak/pkg/vpwned/version.Version=$(VERSION)"
BUILD_OPTIONS += -ldflags=$(LDFLAGS) -buildvcs=false

ifndef PROTOC
PROTOC = protoc
endif

ifndef PROTOC_FILES
PROTOC_FILES := sdk/proto/v1/*.proto
endif

ifndef PKGS
PKGS := $(shell go list ./... 2>&1 | grep -v "versioned")
endif

.PHONY: all

dep:
	@echo "Gathering Dependencies"
	GO111MODULE=on go mod vendor
	go mod download

clean:
	@echo "Cleaning autogenerated proto code and running go clean"
	rm -rf pkg/service/*
	go clean

clean-swagger:
	@echo "Cleaning Swagger"
	go clean
	rm -rf openapiv3/dist openapiv3/proto

get-swagger-ui:
	@echo "Getting Swagger UI"
	wget https://codeload.github.com/swagger-api/swagger-ui/tar.gz/refs/tags/v${SWAGGER_UI_VER} -O openapiv3/v${SWAGGER_UI_VER}.tar.gz && tar -C openapiv3 -zxvf openapiv3/v${SWAGGER_UI_VER}.tar.gz swagger-ui-${SWAGGER_UI_VER}/dist/ && mv openapiv3/swagger-ui-${SWAGGER_UI_VER} openapiv3/swagger-ui
	mv openapiv3/swagger-ui/dist openapiv3/ && rm -rf openapiv3/*.tar.gz openapiv3/swagger-ui

config-swagger:
	sed -i -E -e 's@https://petstore.swagger.io/v2/swagger.json@./apidocs.swagger.json@g' openapiv3/dist/swagger-initializer.js 

get-googleapis-submodule:
	@echo "getting or updating googleapis proto submodule"
	git submodule update --remote --merge

vpwctl:
	@echo "Running make vpwctl"
	cd cmd && CGO_ENABLED=0 go build -mod=vendor $(BUILD_OPTIONS) -o $(BIN_DIR)/vpwctl -v

proto: 
	@echo "Building proto"
	$(PROTOC) -I. \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/sdk/proto/third_party/googleapis \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/vendor \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 \
	--go-grpc_out=api/proto --go_out=api/proto \
	$(PROTOC_FILES)
	#TODO: Add swagger generator command
	$(PROTOC) -I. \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/sdk/proto/third_party/googleapis \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/vendor \
	-I${GOPATH}/src/github.com/platform9/vjailbreak/pkg/vpwned/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 \
	--grpc-gateway_out=logtostderr=true,allow_delete_body=true:api/proto \
	--openapiv2_out ./openapiv3/dist --openapiv2_opt logtostderr=true,allow_merge=true \
	$(PROTOC_FILES)
	go generate github.com/platform9/vjailbreak/pkg/vpwned/api/proto/v1/service
