# Authentik RBAC Configuration

This directory contains Kubernetes manifests for deploying Authentik-based RBAC for vJailbreak.

## Files

- `00-secrets.yaml` - PostgreSQL credentials (auto-generated by setup script)
- `01-namespace.yaml` - Authentik namespace
- `02-postgres.yaml` - PostgreSQL database for Authentik
- `03-redis.yaml` - Redis cache for Authentik
- `04-authentik-server.yaml` - Authentik server and worker deployments
- `05-ingress.yaml` - Ingress configuration (IP-based, no hostname)
- `06-roles.yaml` - ClusterRoles for vJailbreak RBAC
- `07-group-bindings.yaml` - Group to role mappings

## Deployment Order

Run the setup script first to configure for your IP:

```bash
cd /home/ubuntu
./setup-authentik-ip.sh 10.9.3.50  # Replace with your IP
```

Then deploy in order:

```bash
kubectl apply -f 00-secrets.yaml
kubectl apply -f 01-namespace.yaml
kubectl apply -f 02-postgres.yaml
kubectl apply -f 03-redis.yaml
kubectl apply -f 04-authentik-server.yaml
kubectl apply -f 05-ingress.yaml
kubectl apply -f 06-roles.yaml
kubectl apply -f 07-group-bindings.yaml
```

Or apply all at once:

```bash
kubectl apply -f /etc/pf9/yamls/authentik/
```

## IP Address Configuration

This setup is designed for IP-based access (no DNS required).

- Authentik UI: `http://<YOUR_IP>/authentik`
- OAuth2 callback: `http://<YOUR_IP>/oauth2/callback`

Update IP addresses by running:
```bash
./setup-authentik-ip.sh <NEW_IP>
```

## Post-Deployment

After deployment, configure Authentik via the web UI:

1. Access: `http://<YOUR_IP>/authentik`
2. Create admin account
3. Set up OIDC provider
4. Create user groups
5. Update OAuth2 Proxy with client credentials

See `/home/ubuntu/AUTHENTIK-QUICKSTART.md` for detailed steps.
