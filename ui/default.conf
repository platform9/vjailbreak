events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;
    client_max_body_size 500M;

    server {
        # Custom 401 page (optional, you can keep it or remove)
        error_page 401 =401 /__auth_401;
        location = /__auth_401 {
            default_type text/plain;
            return 401 "Authentication required";
        }

        # API endpoints - no auth required (handled by backend services)
        location ~ ^/(api|sdk)/ {
            return 404;
        }

        # Serve debug logs from mounted /var/log/pf9 directory
        location /debug-logs/ {
            alias /var/log/pf9/;
            autoindex on;
            autoindex_format json;
            default_type text/plain;
            add_header Content-Type text/plain;
            # Allow reading log files
            types {
                text/plain log;
            }
        }

        location / {
            # -------------------------------
            # 1. Lua block runs on every request
            # -------------------------------
            access_by_lua_block {
                local SESSION_TIMEOUT = 64800 -- seconds (sliding)

                local cookie = ngx.var.cookie_auth_session
                local now = ngx.time()

                -- If we have a valid non-expired session cookie → skip Basic Auth entirely
                if cookie then
                    local session_ts = tonumber(cookie)
                    if session_ts and (now - session_ts <= SESSION_TIMEOUT) then
                        ngx.log(ngx.ERR,"Session Stable Renewing the session")
                        ngx.header["Set-Cookie"] = "auth_session=" .. now 
                            .. "; Path=/; HttpOnly; Secure; SameSite=Strict"
                        return
                    else
                        -- Expired or invalid cookie → treat as no session
                        ngx.log(ngx.ERR, "Session expired or invalid, forcing re-auth")
                        ngx.header["Set-Cookie"] = "auth_session=; Path=/; Max-Age=0; HttpOnly; Secure"
			ngx.req.clear_header("Authorization")
                    end
                end
                -- Let Nginx's auth_basic module validate the credentials
                -- We temporarily turn it on just for this request
                ngx.auth_request = true  -- internal flag used by auth_basic
            }

            # -------------------------------
            # 2. Normal Basic Auth (still required for validation)
            # -------------------------------
            auth_basic           "Restricted Area";
            auth_basic_user_file /etc/nginx/shadow;

            # -------------------------------
            # 3. If auth_basic succeeded → set/refresh session cookie
            # -------------------------------
            header_filter_by_lua_block {
                local cookie = ngx.var.cookie_auth_session 
                if ngx.status == 200 and not cookie then
                    local now = ngx.time()
                    ngx.header["Set-Cookie"] = "auth_session=" .. now 
                        .. "; Path=/; HttpOnly; Secure; SameSite=Strict"
                    ngx.log(ngx.ERR, "Login successful - session cookie set/renewed to ", now)
                end
            }

            # Your actual application
            root   /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }
    }
}

